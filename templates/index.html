<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Display</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background: #111;
            overflow: hidden;
        }

        /* ---- Base grid behavior ---- */
        .grid {
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }

        /* ---- AUTO LAYOUT ---- */
        {% if layout == "auto" %}
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            grid-auto-rows: 1fr;
            gap: 10px;
            padding: 10px;
        }

        /* ---- HORIZONTAL (SIDE BY SIDE) ---- */
        {% elif layout == "horizontal" %}
        .grid {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: stretch;
            gap: 10px;
            padding: 10px;
        }
        .frame-container {
            flex: 1;
            height: 100%;
        }
        {% endif %}

        /* ---- Common iframe styling ---- */
        .frame-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
            border: 2px solid #333;
            display: flex;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        #empty-message {
        animation: fadeIn 1.2s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.96); }
            to { opacity: 1; transform: scale(1); }
        }


        /* ---- Offline banner ---- */
        #offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 9999;
            text-align: center;
            font-family: sans-serif;
            background: #b00;
            color: white;
            padding: 10px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        #offline-banner.visible {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="offline-banner">
        ‚ö†Ô∏è Offline mode ‚Äî attempting to reconnect...
    </div>

    <div class="grid" id="grid">
        {% if urls and urls|length > 0 %}
            {% for url in urls %}
                <div class="frame-container">
                    <iframe src="{{ url }}" onerror="handleFrameError(this)"></iframe>
                </div>
            {% endfor %}
        {% else %}
            <div id="empty-message" style="
                position:absolute;
                inset:0;
                display:flex;
                align-items:center;
                justify-content:center;
                flex-direction:column;
                text-align:center;
                font-family:'Segoe UI', Roboto, sans-serif;
                color:#ccc;
                background:radial-gradient(circle at center, #1b1b1b 0%, #111 100%);
            ">
                <div style="
                    background:#1e1e1e;
                    border:1px solid #333;
                    border-radius:16px;
                    padding:40px 60px;
                    box-shadow:0 0 20px rgba(0,0,0,0.5);
                    max-width:500px;
                ">
                    <div style="font-size:3em; margin-bottom:10px;">üñ•Ô∏è</div>
                    <div style="font-size:1.4em; font-weight:600; color:#eee;">
                        No content to display
                    </div>
                    <div style="font-size:1em; color:#aaa; margin-top:10px; line-height:1.4em;">
                        You haven‚Äôt added any display URLs yet.<br>
                        Open the <b>Display Manager</b> at<br>
                        <code style="background:#000; color:#4af; padding:2px 6px; border-radius:4px;">/manage</code><br>
                        to add one or more pages.
                    </div>
                </div>
            </div>
        {% endif %}
    </div>



    <script>
        let lastCheck = "{{ time.time() }}";
        let lastKnown = 0;
        let offline = false;

        // --- Unified status + refresh check ---
        async function checkStatus() {
            try {
                const [cfgRes, netRes] = await Promise.all([
                    fetch("/last-updated", { cache: "no-store" }),
                    fetch("/network-status", { cache: "no-store" })
                ]);

                // --- Network check ---
                const net = await netRes.json();
                if (!net.online) {
                    showOffline(true);
                    return;
                }

                // --- Auto-refresh check ---
                const newTime = await cfgRes.text();
                if (lastKnown && newTime !== lastKnown) {
                    console.log("Config updated ‚Äî refreshing display...");
                    location.reload();
                }
                lastKnown = newTime;
                showOffline(false);

            } catch (err) {
                console.warn("Status check failed:", err);
                showOffline(true);
            }
        }

        // --- Offline banner handling ---
        function showOffline(state) {
            const banner = document.getElementById("offline-banner");
            if (state && !offline) {
                banner.classList.add("visible");
                offline = true;
            } else if (!state && offline) {
                banner.classList.remove("visible");
                offline = false;
            }
        }

        // --- Detect iframe load failures ---
        function handleFrameError(iframe) {
            console.error("Frame failed to load:", iframe.src);
            showOffline(true);
        }

        // --- Run every 12 seconds ---
        setInterval(checkStatus, 12000);
    </script>
</body>
</html>